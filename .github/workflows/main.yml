name: Lint And Check
on:
  pull_request:
    branches:
      - main

jobs:
  lint:
    name: Lint
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      pull-requests: read
      actions: write
      contents: read
    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@master

      - name: Run Linting
        id: run-lint
        run: docker compose run --rm --no-deps pdf-agent-lint

  rebase-check:
    name: Check if rebase needed
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Get PR information
        id: pr-info
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: 'main',
              state: 'open'
            });
            return prs.data.map(pr => ({
              number: pr.number,
              head: pr.head.sha
            }));

      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check if rebase needed for PR
        if: github.event_name == 'pull_request'
        id: rebase-check
        run: |
          git fetch origin ${{ github.base_ref }}
          MERGE_BASE=$(git merge-base HEAD "origin/${{ github.base_ref }}")
          TARGET_HEAD=$(git rev-parse "origin/${{ github.base_ref }}")

          if [ "$MERGE_BASE" = "$TARGET_HEAD" ]; then
            echo "rebase_needed=false" >> "$GITHUB_OUTPUT"
            echo "PR is up to date with target branch"
          else
            echo "rebase_needed=true" >> "$GITHUB_OUTPUT"
            echo "PR needs to be rebased"
          fi

      - name: Check Status
        if: github.event_name == 'pull_request' && steps.rebase-check.outputs.rebase_needed == 'true'
        run: exit 1
